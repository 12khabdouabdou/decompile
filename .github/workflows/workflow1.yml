name: 1. Decompile & Save

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Download URL to APK'
        required: true
        type: string

permissions:
  contents: write

jobs:
  decompile:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Download Tools & APK
      run: |
        # FIXED: Download Apktool v2.10.0 from GitHub (not Bitbucket)
        wget https://github.com/iBotPeaches/Apktool/releases/download/v2.10.0/apktool_2.10.0.jar -O apktool.jar -q
        
        echo "Downloading APK..."
        wget "${{ inputs.apk_url }}" -O snapchat.apk -q
        
        filesize=$(stat -c%s "snapchat.apk")
        echo "File size: $filesize"
        if [ "$filesize" -lt 1000000 ]; then
          echo "Error: Downloaded file is too small."
          exit 1
        fi

    - name: Decompile (With Resources)
      run: |
        # REMOVED -r flag so you can edit AndroidManifest.xml
        # -f : Force overwrite
        # -o src : Output to 'src' folder
        # We increase memory to 6GB for large apps like Snapchat
        java -Xmx6144M -jar apktool.jar d -f snapchat.apk -o src

    - name: Push to GitHub
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Add files
        # Note: Large apps have thousands of files, this might take a moment
        git add src/
        
        git commit -m "Auto-decompiled Snapchat (Resources Included)" || echo "No changes to commit"
        
        git pull --rebase origin main
        git push -f origin main
