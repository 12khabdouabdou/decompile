name: 1. Decompile & Save

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct Download URL to APK'
        required: true
        type: string

permissions:
  contents: write

jobs:
  decompile:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Fetch full history

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Download Tools & APK
      run: |
        # Download Apktool
        wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.11.0.jar -O apktool.jar
        
        # Download APK from user input
        echo "Downloading APK..."
        wget "${{ inputs.apk_url }}" -O snapchat.apk
        
        # Verify file size (Must be > 1MB)
        filesize=$(stat -c%s "snapchat.apk")
        echo "File size: $filesize"
        if [ "$filesize" -lt 1000000 ]; then
          echo "Error: Downloaded file is too small. Check your URL."
          exit 1
        fi

    - name: Decompile (Skip Resources)
      run: |
        # -r : Do NOT decode resources (Fixes the styles.xml error)
        # -f : Force overwrite existing folder
        # -o src : Output to 'src' folder
        java -Xmx4096M -jar apktool.jar d -r -f snapchat.apk -o src

    - name: Push to GitHub
      run: |
        # 1. Configure Git
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # 2. Stage the new 'src' folder
        git add src/
        
        # 3. Commit
        git commit -m "Auto-decompiled Snapchat (No Resources)" || echo "No changes to commit"
        
        # 4. Pull latest changes to align history
        git pull --rebase origin main
        
        # 5. Force Push (Overwrites old bad data)
        git push -f origin main
