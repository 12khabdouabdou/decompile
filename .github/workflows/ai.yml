name: JADX Decompile & Consolidate

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct URL to APK file'
        required: true
        type: string

jobs:
  analyze_prep:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install JADX
        run: |
          wget https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip -q -O jadx.zip
          unzip -q jadx.zip -d jadx
          chmod +x jadx/bin/jadx

      - name: Download & Decompile
        run: |
          wget "${{ inputs.apk_url }}" -O target.apk -q
          
          # Decompile (tuned for speed/memory)
          export JAVA_OPTS="-Xmx6g"
          ./jadx/bin/jadx \
            --output-dir decompiled_src \
            --show-bad-code \
            --no-res \
            --threads-count 4 \
            target.apk

      - name: Consolidate Source Code (Filtered)
        run: |
          OUTPUT_FILE="full_source_context.txt"
          echo "Generating consolidated source file..."
          
          # Create header
          echo "#################################################" > "$OUTPUT_FILE"
          echo "# CONSOLIDATED JAVA SOURCE FOR AI ANALYSIS" >> "$OUTPUT_FILE"
          echo "# Excluded: Android, Google, Kotlin, FB, OkHttp" >> "$OUTPUT_FILE"
          echo "# Generated: $(date)" >> "$OUTPUT_FILE"
          echo "#################################################" >> "$OUTPUT_FILE"
          
          # Find Java files BUT EXCLUDE common libraries
          find decompiled_src -name "*.java" \
            -not -path "*/android/*" \
            -not -path "*/androidx/*" \
            -not -path "*/com/google/*" \
            -not -path "*/kotlin/*" \
            -not -path "*/kotlinx/*" \
            -not -path "*/okhttp3/*" \
            -not -path "*/retrofit2/*" \
            -not -path "*/com/facebook/*" \
            -not -path "*/META-INF/*" \
            | sort | while read -r filepath; do
            
            # Optional: Skip files larger than 500KB (usually auto-generated garbage)
            FILE_SIZE=$(stat -c%s "$filepath")
            if [ "$FILE_SIZE" -gt 500000 ]; then
                echo "Skipping large file ($FILE_SIZE bytes): $filepath"
                continue
            fi
            
            echo "" >> "$OUTPUT_FILE"
            echo "////////////////////////////////////////////////////////////////////////////////" >> "$OUTPUT_FILE"
            echo "// FILE PATH: $filepath" >> "$OUTPUT_FILE"
            echo "////////////////////////////////////////////////////////////////////////////////" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            cat "$filepath" >> "$OUTPUT_FILE"
          done
          
          FINAL_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          echo "Consolidation complete. Final size: $FINAL_SIZE"

      - name: Upload Context for Gemini
        uses: actions/upload-artifact@v4
        with:
          name: llm-ready-source-code
          path: full_source_context.txt
          retention-days: 1
