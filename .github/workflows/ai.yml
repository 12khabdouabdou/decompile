name: JADX Decompile & Consolidate

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'Direct URL to APK file'
        required: true
        type: string

jobs:
  analyze_prep:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install JADX
        run: |
          wget https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip -q -O jadx.zip
          unzip -q jadx.zip -d jadx
          chmod +x jadx/bin/jadx

      - name: Download & Decompile
        run: |
          wget "${{ inputs.apk_url }}" -O target.apk -q
          
          # Decompile (tuned for speed/memory)
          # We purposefully skip resources (--no-res) as they clutter the LLM context
          export JAVA_OPTS="-Xmx6g"
          ./jadx/bin/jadx \
            --output-dir decompiled_src \
            --show-bad-code \
            --no-res \
            --threads-count 4 \
            target.apk

      - name: Consolidate Source Code
        run: |
          OUTPUT_FILE="full_source_context.txt"
          echo "Generating consolidated source file..."
          
          # create header
          echo "#################################################" > "$OUTPUT_FILE"
          echo "# CONSOLIDATED JAVA SOURCE FOR AI ANALYSIS" >> "$OUTPUT_FILE"
          echo "# Generated: $(date)" >> "$OUTPUT_FILE"
          echo "#################################################" >> "$OUTPUT_FILE"
          
          # Find all java files, loop through them, and append to output
          find decompiled_src -name "*.java" | sort | while read -r filepath; do
            echo "" >> "$OUTPUT_FILE"
            echo "////////////////////////////////////////////////////////////////////////////////" >> "$OUTPUT_FILE"
            echo "// FILE PATH: $filepath" >> "$OUTPUT_FILE"
            echo "////////////////////////////////////////////////////////////////////////////////" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            # Append content of the file
            cat "$filepath" >> "$OUTPUT_FILE"
          done
          
          FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
          echo "Consolidation complete. Final size: $FILE_SIZE"

      - name: Upload Context for Gemini
        uses: actions/upload-artifact@v4
        with:
          name: llm-ready-source-code
          path: full_source_context.txt
          retention-days: 1
