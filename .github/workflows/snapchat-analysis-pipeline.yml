name: Auto Download and Decompile Snapchat

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 00:00 UTC to check for new versions
    - cron: '0 0 * * 0'

jobs:
  download-and-decompile:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install Python dependencies
        run: |
          pip install requests beautifulsoup4
      
      - name: Download Snapchat APK
        id: download
        run: |
          echo "ðŸ“¥ Downloading Snapchat APK..."
          
          mkdir -p apks
          
          # Method 1: Direct download from APKPure
          echo "Trying APKPure..."
          curl -L -o "apks/snapchat.apk" \
            "https://d.apkpure.com/b/APK/com.snapchat.android?version=latest" \
            --max-time 300 \
            --connect-timeout 30 || echo "APKPure failed"
          
          # Check if download succeeded
          if [ -f "apks/snapchat.apk" ] && [ -s "apks/snapchat.apk" ]; then
            echo "âœ… Downloaded from APKPure"
          else
            # Method 2: Try APKCombo
            echo "Trying APKCombo..."
            curl -L -o "apks/snapchat.apk" \
              "https://apkcombo.com/downloader/download?package=com.snapchat.android&region=US&arches=arm64-v8a" \
              --max-time 300 || echo "APKCombo failed"
          fi
          
          # Verify we got an APK
          if [ ! -f "apks/snapchat.apk" ] || [ ! -s "apks/snapchat.apk" ]; then
            echo "âŒ All download methods failed!"
            echo "Please download manually from:"
            echo "1. https://www.apkmirror.com/apk/snap-inc/snapchat/"
            echo "2. https://apkpure.com/snapchat/com.snapchat.android"
            exit 1
          fi
          
          # Get APK info
          APK_SIZE=$(du -h apks/snapchat.apk | cut -f1)
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "âœ… APK downloaded: $APK_SIZE"
      
      - name: Download JADX
        run: |
          echo "ðŸ“¦ Downloading JADX..."
          wget -q https://github.com/skylot/jadx/releases/download/v1.5.0/jadx-1.5.0.zip
          unzip -q jadx-1.5.0.zip -d jadx
          chmod +x jadx/bin/jadx
          echo "âœ… JADX ready"
      
      - name: Decompile APK
        id: decompile
        run: |
          echo "ðŸ”§ Decompiling Snapchat APK with JADX..."
          
          ./jadx/bin/jadx \
            --output-dir decompiled \
            --threads-count 4 \
            --deobf \
            --show-bad-code \
            --no-res \
            --no-src \
            apks/snapchat.apk
          
          echo "âœ… Decompilation complete!"
          
          # Count classes
          CLASS_COUNT=$(find decompiled -name "*.java" 2>/dev/null | wc -l || echo "0")
          echo "class_count=$CLASS_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Decompiled $CLASS_COUNT Java classes"
      
      - name: Extract version info
        id: version
        run: |
          # Try to get version from AndroidManifest or build info
          VERSION="unknown-$(date +%Y%m%d)"
          
          # Search for version string in decompiled code
          if [ -d "decompiled" ]; then
            FOUND_VERSION=$(grep -r "versionName" decompiled 2>/dev/null | head -n 1 | grep -oP '\d+\.\d+\.\d+' | head -n 1 || echo "")
            if [ -n "$FOUND_VERSION" ]; then
              VERSION="$FOUND_VERSION"
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Snapchat Version: $VERSION"
      
      - name: Create analysis summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APK_SIZE="${{ steps.download.outputs.apk_size }}"
          CLASS_COUNT="${{ steps.decompile.outputs.class_count }}"
          
          mkdir -p decompiled
          
          cat > decompiled/DECOMPILATION_SUMMARY.md << EOF
          # Snapchat Decompilation Summary
          
          **Date:** $(date)
          **Version:** $VERSION
          **APK Size:** $APK_SIZE
          **Classes Decompiled:** $CLASS_COUNT
          **Workflow Run:** ${{ github.run_id }}
          
          ## Main Packages
          
          \`\`\`
          $(find decompiled -type d -path "*/com/snapchat/*" -maxdepth 5 2>/dev/null | sed 's|decompiled/sources/||' | sort | uniq | head -n 30 || echo "Package list not available")
          \`\`\`
          
          ## Key Classes for SnapEnhance Hooks
          
          ### Media Upload
          \`\`\`
          $(find decompiled -name "*Media*.java" -o -name "*Upload*.java" 2>/dev/null | head -n 10 || echo "Search in sources/")
          \`\`\`
          
          ### Video Processing
          \`\`\`
          $(find decompiled -name "*Video*.java" 2>/dev/null | head -n 10 || echo "Search in sources/")
          \`\`\`
          
          ## How to Use
          
          1. Download the artifact from this workflow run
          2. Extract the decompiled-snapchat.zip file
          3. Browse Java code in \`sources/\` folder
          4. Use search to find specific classes/methods
          5. Document findings in your project
          
          ## Next Steps
          
          - Identify hook points for SnapEnhance
          - Compare with previous version (if available)
          - Update hook catalog
          - Document in findings-log.md
          
          EOF
          
          cat decompiled/DECOMPILATION_SUMMARY.md
      
      - name: Upload decompiled code
        uses: actions/upload-artifact@v4
        with:
          name: decompiled-snapchat-${{ steps.version.outputs.version }}
          path: decompiled/
          retention-days: 30
      
      - name: Upload original APK
        uses: actions/upload-artifact@v4
        with:
          name: snapchat-apk-${{ steps.version.outputs.version }}
          path: apks/snapchat.apk
          retention-days: 90
      
      - name: Create workflow summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APK_SIZE="${{ steps.download.outputs.apk_size }}"
          CLASS_COUNT="${{ steps.decompile.outputs.class_count }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… Snapchat Auto-Decompilation Complete!
          
          ## ðŸ“¦ Version Information
          - **Version:** \`$VERSION\`
          - **APK Size:** $APK_SIZE
          - **Classes:** $CLASS_COUNT
          - **Date:** $(date)
          
          ## ðŸ“¥ Artifacts Generated
          
          Two artifacts are available for download:
          
          1. **decompiled-snapchat-$VERSION** - Decompiled Java source code
          2. **snapchat-apk-$VERSION** - Original APK file
          
          ## ðŸ” What's Inside
          
          - All Snapchat classes decompiled to readable Java
          - Package structure preserved
          - Deobfuscated names (where possible)
          - Complete source code analysis ready
          
          ## ðŸ“– Next Steps
          
          1. Download the decompiled artifact
          2. Search for hook targets:
             - Media upload classes
             - Video processing logic
             - Chat functionality
          3. Document findings in \`docs/reverse-engineering/findings-log.md\`
          4. Update SnapEnhance hooks as needed
          
          ## ðŸ”— Useful Searches
          
          Once downloaded, search for:
          - \`MediaUploader\` - Media upload logic
          - \`VideoProcessor\` - Video handling
          - \`sendMessage\` - Chat functionality
          - \`ChatManager\` - Chat system
          
          EOF
