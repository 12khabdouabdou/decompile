name: Snapchat APK Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      snapchat_version:
        description: 'Snapchat version to download (e.g., 12.75.0.38)'
        required: false
        type: string
      auto_latest:
        description: 'Auto-download latest version'
        required: false
        type: boolean
        default: true
  schedule:
    # Run weekly on Sunday at 00:00 UTC to check for new versions
    - cron: '0 0 * * 0'

env:
  JADX_VERSION: '1.5.0'
  APKEEP_VERSION: '0.18.0'

jobs:
  download-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install apkeep
        run: |
          echo "ðŸ“¦ Installing apkeep v${APKEEP_VERSION}..."
          
          # Try with specified version first
          if ! curl -fSL -o apkeep.tar.gz \
            "https://github.com/EFForg/apkeep/releases/download/v${APKEEP_VERSION}/apkeep-x86_64-unknown-linux-gnu.tar.gz"; then
            echo "âš ï¸  Version ${APKEEP_VERSION} not found, trying latest..."
            
            # Fallback to latest release
            LATEST_URL=$(curl -s https://api.github.com/repos/EFForg/apkeep/releases/latest | \
              grep "browser_download_url.*apkeep-x86_64-unknown-linux-gnu.tar.gz" | \
              cut -d '"' -f 4)
            
            curl -fSL -o apkeep.tar.gz "$LATEST_URL"
          fi
          
          tar -xzf apkeep.tar.gz
          chmod +x apkeep
          sudo mv apkeep /usr/local/bin/
          rm apkeep.tar.gz
          
          apkeep --version
          echo "âœ… apkeep installed successfully"
      
      - name: Download Snapchat APK from APKMirror
        id: download_apk
        run: |
          mkdir -p apks
          
          if [ "${{ github.event.inputs.auto_latest }}" == "true" ] || [ -z "${{ github.event.inputs.snapchat_version }}" ]; then
            echo "ðŸ“¥ Downloading latest Snapchat version..."
            
            # Download latest version
            apkeep -a com.snapchat.android \
              -d apks/ \
              -p 1
            
            # Get the downloaded file
            APK_FILE=$(ls -t apks/com.snapchat.android_*.apk | head -n 1)
            
            # Extract version from filename
            VERSION=$(basename "$APK_FILE" | sed 's/com.snapchat.android_\(.*\)\.apk/\1/')
          else
            echo "ðŸ“¥ Downloading Snapchat version ${{ github.event.inputs.snapchat_version }}..."
            
            # Download specific version
            apkeep -a com.snapchat.android@${{ github.event.inputs.snapchat_version }} \
              -d apks/
            
            APK_FILE=$(ls -t apks/com.snapchat.android_*.apk | head -n 1)
            VERSION="${{ github.event.inputs.snapchat_version }}"
          fi
          
          echo "âœ… Downloaded: $APK_FILE"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT
          
          # Get file size
          SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
      
      - name: Verify APK
        run: |
          APK_FILE="${{ steps.download_apk.outputs.apk_path }}"
          
          echo "ðŸ” Verifying APK..."
          
          # Check if file exists and is not empty
          if [ ! -s "$APK_FILE" ]; then
            echo "âŒ APK file is empty or missing!"
            exit 1
          fi
          
          # Check file signature (basic validation)
          file "$APK_FILE"
          
          # Extract APK info using aapt (if available)
          if command -v aapt &> /dev/null; then
            aapt dump badging "$APK_FILE" | grep -E "package|versionCode|versionName"
          fi
      
      - name: Install JADX
        run: |
          echo "ðŸ“¦ Installing JADX..."
          wget https://github.com/skylot/jadx/releases/download/v${JADX_VERSION}/jadx-${JADX_VERSION}.zip
          unzip jadx-${JADX_VERSION}.zip -d jadx
          chmod +x jadx/bin/jadx
          jadx/bin/jadx --version
      
      - name: Decompile APK with JADX
        id: decompile
        run: |
          APK_FILE="${{ steps.download_apk.outputs.apk_path }}"
          VERSION="${{ steps.download_apk.outputs.version }}"
          OUTPUT_DIR="decompiled/snapchat-${VERSION}"
          
          echo "ðŸ”§ Decompiling Snapchat ${VERSION}..."
          
          ./jadx/bin/jadx \
            --output-dir "$OUTPUT_DIR" \
            --show-bad-code \
            --no-res \
            --no-src \
            --threads-count 4 \
            --deobf \
            "$APK_FILE"
          
          echo "âœ… Decompilation complete!"
          echo "output_dir=$OUTPUT_DIR" >> $GITHUB_OUTPUT
          
          # Count decompiled files
          CLASS_COUNT=$(find "$OUTPUT_DIR" -name "*.java" 2>/dev/null | wc -l || echo "0")
          echo "class_count=$CLASS_COUNT" >> $GITHUB_OUTPUT
      
      - name: Extract Key Information
        run: |
          OUTPUT_DIR="${{ steps.decompile.outputs.output_dir }}"
          VERSION="${{ steps.download_apk.outputs.version }}"
          
          echo "ðŸ“Š Extracting key information..."
          
          mkdir -p docs/reverse-engineering/snapchat-versions/${VERSION}
          
          # Extract version info
          cat > docs/reverse-engineering/snapchat-versions/${VERSION}/metadata.md << EOF
          # Snapchat Version ${VERSION}
          
          **Downloaded:** $(date)
          **APK Size:** ${{ steps.download_apk.outputs.size }}
          **Total Classes:** ${{ steps.decompile.outputs.class_count }}
          **Workflow Run:** ${{ github.run_id }}
          
          ## Package Structure
          EOF
          
          # List main packages
          find "$OUTPUT_DIR" -type d -path "*/com/snapchat/*" -maxdepth 5 | \
            sed "s|$OUTPUT_DIR/sources/||" | \
            sort | uniq | head -n 50 >> docs/reverse-engineering/snapchat-versions/${VERSION}/metadata.md
      
      - name: Find Hook Targets
        run: |
          OUTPUT_DIR="${{ steps.decompile.outputs.output_dir }}"
          VERSION="${{ steps.download_apk.outputs.version }}"
          
          echo "ðŸŽ¯ Finding hook targets for SnapEnhance..."
          
          # Search for classes related to video/media handling
          HOOK_TARGETS_FILE="docs/reverse-engineering/snapchat-versions/${VERSION}/hook-targets.md"
          
          cat > "$HOOK_TARGETS_FILE" << EOF
          # Hook Targets - Snapchat ${VERSION}
          
          **Generated:** $(date)
          
          ## Media Upload Classes
          EOF
          
          # Find media-related classes
          find "$OUTPUT_DIR" -name "*.java" | xargs grep -l "class.*Media.*Upload" | \
            sed "s|$OUTPUT_DIR/sources/||; s|/|.|g; s|.java||" | \
            while read class; do
              echo "- \`$class\`" >> "$HOOK_TARGETS_FILE"
            done || true
          
          echo -e "\n## Video Processing Classes" >> "$HOOK_TARGETS_FILE"
          
          find "$OUTPUT_DIR" -name "*.java" | xargs grep -l "class.*Video.*Process" | \
            sed "s|$OUTPUT_DIR/sources/||; s|/|.|g; s|.java||" | head -n 20 | \
            while read class; do
              echo "- \`$class\`" >> "$HOOK_TARGETS_FILE"
            done || true
          
          echo -e "\n## Chat/Messaging Classes" >> "$HOOK_TARGETS_FILE"
          
          find "$OUTPUT_DIR" -name "*.java" | xargs grep -l "class.*Chat\|class.*Message" | \
            sed "s|$OUTPUT_DIR/sources/||; s|/|.|g; s|.java||" | head -n 20 | \
            while read class; do
              echo "- \`$class\`" >> "$HOOK_TARGETS_FILE"
            done || true
      
      - name: Generate Analysis Report
        run: |
          VERSION="${{ steps.download_apk.outputs.version }}"
          
          cat > docs/reverse-engineering/snapchat-versions/${VERSION}/ANALYSIS_REPORT.md << 'EOF'
          # Snapchat ${VERSION} Analysis Report
          
          **Date:** $(date)
          **Workflow:** ${{ github.run_id }}
          **APK Source:** APKMirror
          
          ## Summary
          
          - **Version:** ${VERSION}
          - **APK Size:** ${{ steps.download_apk.outputs.size }}
          - **Classes:** ${{ steps.decompile.outputs.class_count }}
          - **Decompilation Status:** âœ… Success
          
          ## Files Generated
          
          - [Metadata](metadata.md)
          - [Hook Targets](hook-targets.md)
          - Full decompiled source (available in artifacts)
          
          ## Next Steps
          
          1. Review hook targets for SnapEnhance compatibility
          2. Compare with previous version (if available)
          3. Update SnapEnhance hooks if API changes detected
          
          EOF
      
      - name: Upload decompiled source as artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapchat-decompiled-${{ steps.download_apk.outputs.version }}
          path: ${{ steps.decompile.outputs.output_dir }}/
          retention-days: 30
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapchat-apk-${{ steps.download_apk.outputs.version }}
          path: ${{ steps.download_apk.outputs.apk_path }}
          retention-days: 90
      
      - name: Commit documentation to repository
        run: |
          VERSION="${{ steps.download_apk.outputs.version }}"
          
          git config user.name "Snapchat Analysis Bot"
          git config user.email "analysis-bot@github.com"
          
          git add docs/reverse-engineering/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Add Snapchat ${VERSION} analysis documentation"
            git push
          fi
      
      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“Š Snapchat Analysis Complete
          
          ## âœ… Successfully Analyzed Version: \`${{ steps.download_apk.outputs.version }}\`
          
          ### ðŸ“¦ APK Details
          - **Size:** ${{ steps.download_apk.outputs.size }}
          - **Source:** APKMirror
          - **Classes Found:** ${{ steps.decompile.outputs.class_count }}
          
          ### ðŸ“ Artifacts Generated
          - Decompiled source code
          - APK file
          - Analysis documentation
          
          ### ðŸ“– Documentation
          - Location: \`docs/reverse-engineering/snapchat-versions/${{ steps.download_apk.outputs.version }}/\`
          - [View Analysis Report](docs/reverse-engineering/snapchat-versions/${{ steps.download_apk.outputs.version }}/ANALYSIS_REPORT.md)
          - [View Hook Targets](docs/reverse-engineering/snapchat-versions/${{ steps.download_apk.outputs.version }}/hook-targets.md)
          
          ### ðŸŽ¯ Next Steps
          1. Review the hook targets
          2. Compare with previous version
          3. Update SnapEnhance hooks if needed
          EOF
